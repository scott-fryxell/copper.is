(function(){
  var f = document.getElementById('weave');
  if (f) {
    console.debug("this shouldn't have happened. Iframes should be cleaned up.")
  }
  else {
    f=document.createElement('iframe');
    f.id='weave';
    f.frameborder=0;
    f.scrolling=0;
    f.target='weave';
    f.allowtransparency='allowtransparency';
    f.style.position='fixed';
    f.style.top='0';
    f.style.padding='0';
    f.style.zIndex='-1000';
    f.style.margin='0';
    f.style.border='none';
    f.style.left='0';
    f.style.background.color='transparent';
    f.scrolling='no';
    f.src='<%=request.scheme%>://<%=request.host%>:<%=request.port%>/bookmarklet/agent/#/' +
      window.location + '&title=' + document.getElementsByTagName('title')[0].innerHTML;
    document.body.appendChild(f);
    f.width='100%';
    f.height='100%';
    f.style.zIndex='1000';
    window.addEventListener('message',function(event) {
      if (event.origin == '<%=request.scheme%>://<%=request.host%>:<%=request.port%>') {
        if (event.data == 'notify_complete') {
          var weave = document.getElementById('weave');
          document.body.removeChild(weave);
        }
      }
    }, false);
  }
})()
