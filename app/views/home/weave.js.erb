(function(){
  var f = document.getElementById('weave');
  if (f) {
    f.contentWindow.postMessage('re_tip', '<%=request.scheme%>://<%=request.host%>:<%=request.port%>');
    f.style.zIndex=1000;
  }
  else {
    f=document.createElement('iframe');
    f.id='weave';
    f.frameborder=0;
    f.scrolling=0;
    f.target='weave';
    f.allowtransparency='allowtransparency';
    f.style.position='absolute';
    f.style.top='0';
    f.style.padding='0';
    f.style.zIndex='1000';
    f.style.margin='0';
    f.style.border='none';
    f.style.left='0';
    f.scrolling='no';
    f.width='100%';
    f.height='100%';
    f.src='<%=request.scheme%>://<%=request.host%>:<%=request.port%>/bookmarklet/agent/#/' +
      window.location + '&title=' +
      document.getElementsByTagName('title')[0].innerHTML;
    document.body.appendChild(f);
    window.addEventListener('message',function(event) {
      if (event.origin == '<%=request.scheme%>://<%=request.host%>:<%=request.port%>') {
        console.debug(event.origin);
        if (event.data == 'notify_complete') {
          document.getElementById('weave').style.zIndex = -100;
        }
      }
    });
  }
})()
