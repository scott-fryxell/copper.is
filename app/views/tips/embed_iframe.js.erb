<% cache do %>
(function(){
  var f = document.getElementById('copper');
  if (f) {
    console.error("The copper iframe should have been removed.")
  }
  else {
    f=document.createElement('iframe');
    f.id='copper';
    f.frameborder=0;
    f.scrolling=0;
    f.target='weave';
    f.allowtransparency='allowtransparency';
    f.style.position='fixed';
    f.style.top='0';
    f.style.padding='0';
    f.style.zIndex='-1000';
    f.style.margin='0';
    f.style.border='none';
    f.style.left='0';
    f.style.background.color='transparent';
    f.scrolling='no';
    f.src='<%=request.scheme%>://<%=request.host%>:<%=request.port%>/tips/agent/?uri=' +
      window.location + '&title=' + document.getElementsByTagName('title')[0].innerHTML;
    document.body.appendChild(f);
    f.width='0';
    f.height='0';
    f.style.zIndex='9999999999999999';
    window.addEventListener('message',function(event) {
      // if (event.origin == '<%=request.scheme%>://<%=request.host%>:<%=request.port%>') {
        if (event.data == 'notify_complete') {
          var frame = document.getElementById('copper');
          document.body.removeChild(frame);
        }
        else if (event.data == 'reset_frame'){
          frame = document.getElementById('copper');
          f.width='0';
          f.height='0';
          frame.src='<%=request.scheme%>://<%=request.host%>:<%=request.port%>/tips/agent/?uri=' +
            window.location + '&title=' + document.getElementsByTagName('title')[0].innerHTML;
        }
        else if (event.data == 'resize_frame'){
          frame = document.getElementById('copper');
          f.width='100%';
          f.height='100%';
        }
      // }
    }, false);
  }
})()
<% end %>
