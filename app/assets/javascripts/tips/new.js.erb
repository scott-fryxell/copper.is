//= require jquery
//= require jquery.cookie
//= require jquery.timeago
//= require jquery.tmpl
//= require shared/Item
//= require shared/copper

$(document).ready(function (){
  document.postMessage({type:'gather_page_info'})
  $("section > a, section > button").click(function(event){
    $(document).trigger("tip_hide")
  });
});
$(document).bind({
  "tip_details": function (event){
    document.postMessage({type:'show_details'})
    $("body > section").addClass("details")

    // embed the twitter iframe
    $('#share > a').attr('data-url', document.getItems('tips')[0].url);
    $('#share > div').attr('data-href', document.getItems('tips')[0].url);

    var js, fjs=document.getElementsByTagName('script')[0];
    window.setTimeout(function (){ 
      if (document.getElementById('twitter-wjs')) return;
      js=document.createElement('script');
      js.id='twitter-wjs';
      js.src="//platform.twitter.com/widgets.js";
      fjs.parentNode.insertBefore(js,fjs);
    },1000);

    // embed the facebook like iframe
    if (document.getElementById('facebook-jssdk')) return;
    var js = document.createElement('script'); 
    js.id = 'facebook-jssdk';
    js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=340706775966925";
    fjs.parentNode.insertBefore(js, fjs);

  },
  "tip_info": function (event){
      title = decodeURIComponent(event.title)
      new_tip = document.getItems('tips')[0]
      new_tip.title = decodeURIComponent(event.title)
      new_tip.url = decodeURIComponent(event.url)
      Item.update_page(new_tip)
      $("form").submit()
      $(document).trigger("tip_display")
  },
  "tip_display": function (event){
      document.copper.format_cents_to_dollars("amount_in_cents")      
      document.postMessage({type:'show'})
      $("body > section").addClass("show")
      if($("section").hasClass('sign_in')) return;
      window.setTimeout(function (){
        $(document).trigger("tip_hide")
      },3000);     
  },
  "tip_hide": function(event){
    $("body > section").removeClass('show')
    $("body > section").removeClass('details')
    window.setTimeout(function (){
      document.postMessage({type:'hide'})
    },2000);
  }
});
window.addEventListener('message', function(event) {
  $(document).trigger(event.data)
});
document.postMessage = function (message){
  window.parent.postMessage(message, "*");
}
