//= require jquery
//= require jquery.cookie
//= require jquery.timeago
//= require jquery.tmpl
//= require shared/Item
//= require shared/copper

$(document).ready(function (){
  document.postMessage(JSON.stringify({type:'tip_info'}))

  $("section.sign_in a").click(function(event){
    $(document).trigger("tip_hide")
  });
});
$(document).bind({
  "tip_info": function (event){
    title = decodeURIComponent(event.title)
    new_tip = document.getItems('tips')['/tips/new']
    new_tip.title = decodeURIComponent(event.title)
    new_tip.url = decodeURIComponent(event.url)
    new_tip.thumbnail_url = decodeURIComponent(event.thumbnail_url)
    Item.update_page(new_tip)
    copper.format_cents_to_dollars("amount_in_cents")

    jQuery('<img/>', {
      id: 'create_img',
      src: decodeURIComponent(event.thumbnail_url),
      style: 'opacity:0;'
    }).appendTo('body');

    $(document).trigger("tip_display")
  },
  "tip_display": function (event){
    $("body > form").submit()
    document.postMessage(JSON.stringify({type:'show'}))
    $("body > section").addClass("show")

    if(!$("section").hasClass('sign_in')){
      window.setTimeout(function (){
        $(document).trigger("tip_hide")
      },3000);

      window.setTimeout(function (){
        document.postMessage(JSON.stringify({type:'hide'}))
      },4000);      
    }
  },
  "items.updated.tips_new": function(event){
    copper.format_cents_to_dollars("amount_in_cents")
  },
  "tip_hide": function(event){
    $("body > section").removeClass('show')
  }
});
window.addEventListener('message', function(event) {
  $(document).trigger(JSON.parse(event.data))
});
document.postMessage = function (message){
  window.parent.postMessage(message, "*");
}
