//= require jquery
//= require jquery.cookie
//= require jquery.timeago
//= require jquery.tmpl
//= require shared/Item
//= require shared/copper

$(document).ready(function (){
  document.postMessage({type:'gather_page_info'})
  $("a.button").click(function(event){
    $("form[method=put]").submit();
  });
});
$(document).bind({
  "tip_details": function (event){
    clearInterval(hide_tip);
    document.postMessage({type:'show_details'});
    $("body > section").addClass("details");

    // embed the twitter iframe
    $('#share > a').attr('data-url', document.getItems('tips')[0].url);
    $('#share > div').attr('data-href', document.getItems('tips')[0].url);
    $("input[itemprop=amount_in_dollars]").focus();
    // var js, fjs=document.getElementsByTagName('script')[0];
    // window.setTimeout(function (){ 
    //   if (document.getElementById('twitter-wjs')) return;
    //   js=document.createElement('script');
    //   js.id='twitter-wjs';
    //   js.src="//platform.twitter.com/widgets.js";
    //   fjs.parentNode.insertBefore(js,fjs);
    // },1000);

    // // embed the facebook like iframe
    // if (document.getElementById('facebook-jssdk')) return;
    // var js = document.createElement('script'); 
    // js.id = 'facebook-jssdk';
    // js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=340706775966925";
    // fjs.parentNode.insertBefore(js, fjs);
  },
  "tip_info": function (event){
      title = decodeURIComponent(event.title)
      new_tip = document.getItems('tips')[0]
      new_tip.title = decodeURIComponent(event.title)
      new_tip.url = decodeURIComponent(event.url)
      Item.update_page(new_tip)
      $("form").submit()
      $(document).trigger("tip_display")
  },
  "tip_display": function (event){
      var cents = $("input[itemprop=amount_in_dollars]").attr('value');
      var dollars = document.copper.cents_to_dollars(cents);
      $("input[itemprop=amount_in_dollars]").attr('value', dollars);
      document.postMessage({type:'show'})
      $("body > section").addClass("show")
      if(!$("section").hasClass('sign_in')){
        hide_tip;
      }
  },
  "tip_hide": function(event){
    $("body > section").removeClass('show')
    $("body > section").removeClass('details')
    window.setTimeout(function (){
      document.postMessage({type:'hide'})
    },2000);
  }
});

$('form').on('item.post', function(event, data, status, xhr){
  $(this).attr('method', 'put');
  $(this).attr('action', data);
  $(this).on('item.validate', function(){
    $(this).find("input[itemprop=amount_in_dollars]").removeClass('invalid')
    var dollars = $(this).find("input[itemprop=amount_in_dollars]").attr('value');
    if(isNaN(dollars)){
      $(this).find("input[itemprop=amount_in_dollars]").addClass('invalid')
      console.debug("not a number", dollars);
    } else {
      var cents = dollars * 100;
      $(this).find("input[itemprop=amount_in_cents]").attr('value', cents)
      console.debug("populate amount in cents", cents);
      $(document).trigger("tip_hide");
    }
  });
});

var hide_tip = window.setTimeout(function(){$(document).trigger("tip_hide")},3000);

$(document).keyup(function(e) {
  if (e.keyCode == 27) { $(document).trigger("tip_hide"); }   // esc
});

$("#twitter").click(function(){
  url=encodeURIComponent(document.getItems('tips')[0].url)
  href="https://twitter.com/intent/tweet?source=webclient&hashtags=tipping&url=" + url;
  $(this).attr('href', href);
});
$("#facebook").click(function(){
  FB.init({appId: "340706775966925", status: true, cookie: true});
  var obj = {
    method: 'feed',
    redirect_uri: 'https://www.copper.is',
    link: document.getItems('tips')[0].url
  };
  FB.ui(obj);
});
$("#tumblr_button_abc123").click(function(){
  href = "http://www.tumblr.com/share/link?url=" + encodeURIComponent(document.getItems('tips')[0].url) +  "&name=" + encodeURIComponent(document.getItems('tips')[0].title) + "&tags=tipping%20copper_is";
  $(this).attr('href', href);
});

window.addEventListener('message', function(event) {
  $(document).trigger(event.data)
});
document.postMessage = function (message){
  window.parent.postMessage(message, "*");
}
