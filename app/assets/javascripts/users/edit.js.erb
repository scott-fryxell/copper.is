$(document).ready(function (){
  Stripe.setPublishableKey('<%=Copper::Application.config.stripe_key%>');
  var rate = $("p[itemprop=tip_preference_in_cents]").text().trim()
  $('#month > option[value='+ new String(new Date().getMonth() + 1) +']').attr('selected', 'selected')
  $('#rate > form > select > option[value=' + rate +']').attr('selected', true)
  format_rate()
  $(document).on("copper:update_page_items", function (){
    format_rate()
  })
});
$(document).on("copper:items", function (){
  user = document.getItems()['users'][((window.location.pathname).replace('/edit', ''))]
});

function format_rate(){
  var rate = $("p[itemprop=tip_preference_in_cents]").text().trim()
  rate = (parseFloat(rate) / 100.00)
  if( rate == 0.5 || rate == 0.1){
    rate = rate + '0'
  }
  $("p[itemprop=tip_preference_in_cents]").text(rate)
}
$(document).ready(function (){
  $("section > header > a").click(function(event){
    event.preventDefault();
    var div = $(this).parents("section").find("div");
    var form = $(this).parents("section").find("form")
    $(this).animate({opacity:0}, 200);
    div.animate({opacity:0},500, function (){
      div.css("display", "none")
      form.css("display", "inline-block")
      form.animate({opacity:1},500);
    });
  });

  $("section > form").submit(function(event){
    event.preventDefault()
    div = $(this).parents("section").find("div")
    $(this).animate({opacity:0},500,function (){
      $(this).css("display", "none")
      $(this).parents("section").find("header > a").animate({opacity:1}, 200)
      div.css("display","inline-block")
      div.animate({opacity:1}, 500)
    });
  });

  if (!user.credit_card_id){
    $("#card > header > a").click();
  }

  if (!user.email){
    $("#email > header > a").click();
  }
  $('#email form').bind('form:invalid', function (){
    console.debug("invalid form")
    $('#email > header > a').click();
    $(this).find('input[itemprop=email]').addClass('invalid');
  });

});


$(document).ready(function() {
  $("#card > form").submit(function(event) {
    event.preventDefault();
    if( !Stripe.validateCardNumber($('#number').val())){
      console.error("invalid credit card number");
      $('#number').addClass("invalid");
    } else {
      $('#number').removeClass("invalid");
    }
    if( !Stripe.validateCVC($('#cvc').val() ) ){
      console.error("invalid cvc");
      $('#cvc').addClass("invalid");
    } else {
      $('#cvc').removeClass("invalid");
    }
    if( !Stripe.validateExpiry($('#month').val(), $('#year').val()) ) {
      console.error("invalid expiration")
      $('#month').addClass("invalid");
      $('#year').addClass("invalid");
    } else {
      $('#month').removeClass("invalid");
      $('#year').removeClass("invalid");
    }
    if( $("#site_terms:checked").length == 1 ){
      $('#site_terms').removeClass("invalid");
    }else{
      console.error("must agree to terms");
      $('#site_terms').addClass("invalid");
    }
    if($('#card .invalid').length > 0){
      console.debug('invalid');
      $('#card > header > a').click();
      return false;
    }
    Stripe.createToken(
      {
        number:$('#number').val(),
        cvc:$('#cvc').val(),
        exp_month:$('#month').val(),
        exp_year:$('#year').val(),
        email:$('#email').val()
      },
      function (status, response) {
        console.debug(status, response);
        if (response.error) {
          $("#card > form > h1").text(response.error.message)
          $("#card > form > h1").addClass("message")
        } else {
          $("#card > form > h1").removeClass("message")
          $(document).trigger("copper:create_stripe_customer_id")
          $("input[name=stripe_token]").val(response['id']);
          $("#card p.type").text(response.card.type)
          $("#card p.number").text(response.card.last4)
          $("#card p.expiration").text(response.card.exp_month + '/' + response.card.exp_year )
        }
      }
    );
    return false;
  });
});
