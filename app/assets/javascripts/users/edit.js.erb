$(document).on("copper:users_edit", function (){
  Stripe.setPublishableKey('<%=Copper::Application.config.stripe_key%>');
  var rate = $("p[itemprop=tip_preference_in_cents]").text().trim()
  $('#month > option[value='+ new String(new Date().getMonth() + 1) +']').attr('selected', 'selected')
  $('#rate > form > select > option[value=' + rate +']').attr('selected', true)
  copper.format_cents_to_dollars("tip_preference_in_cents")
});
$(document).on("copper:users_edit:update_page_items", function (){
  copper.format_cents_to_dollars("tip_preference_in_cents")
})

$(document).on("copper:users_edit", function (){
  $("#card > form").submit(function(event) {
    event.preventDefault();
    if( !Stripe.validateCardNumber($('#number').val())){
      console.error("invalid credit card number");
      $('#number').addClass("invalid");
    } else {
      $('#number').removeClass("invalid");
    }
    if( !Stripe.validateCVC($('#cvc').val() ) ){
      console.error("invalid cvc");
      $('#cvc').addClass("invalid");
    } else {
      $('#cvc').removeClass("invalid");
    }
    if( !Stripe.validateExpiry($('#month').val(), $('#year').val()) ) {
      console.error("invalid expiration")
      $('#month').addClass("invalid");
      $('#year').addClass("invalid");
    } else {
      $('#month').removeClass("invalid");
      $('#year').removeClass("invalid");
    }
    if( $("#site_terms:checked").length == 1 ){
      $('#site_terms').removeClass("invalid");
    }else{
      console.error("must agree to terms");
      $('#site_terms').addClass("invalid");
    }
    if($('#card .invalid').length > 0){
      $('#card > header > a').click();
      return false;
    }
    Stripe.createToken(
      {
        number:$('#number').val(),
        cvc:$('#cvc').val(),
        exp_month:$('#month').val(),
        exp_year:$('#year').val(),
        email:$('#email').val()
      },
      function (status, response) {
        // console.debug(status, response);
        if (response.error) {
          $("#card > form > h1").text(response.error.message)
          $("#card > form > h1").addClass("message")
          return
        }
        $("#card > form > h1").removeClass("message")
        $("#card p.type").text(response.card.type)
        $("#card p.number").text(response.card.last4)
        $("#card p.expiration").text(response.card.exp_month + '/' + response.card.exp_year )

        // post the tip to create if the user hasn't created a stripe id
        var method = 'post'
        if(user.stripe_id){
          method = 'put'
        }
        jQuery.ajax({
          url: '/cards',
          type: method,
          data: 'card_token=' + response.id,
          error: function(data, textStatus, jqXHR) {
            console.error("error creating stripe user " + method, data, textStatus, jqXHR);
          }
        });
      }
    );
    return false;
  });
});
$(document).on("copper:users_edit:items", function (){
  $("section > header > a").click(function(event){
    event.preventDefault();
    var div = $(this).parents("section").find("div");
    var form = $(this).parents("section").find("form")
    $(this).animate({opacity:0}, 200);
    div.animate({opacity:0},500, function (){
      div.css("display", "none")
      form.css("display", "inline-block")
      form.animate({opacity:1},500);
    });
  });
  $("section > form").submit(function(event){
    event.preventDefault()
    div = $(this).parents("section").find("div")
    $(this).animate({opacity:0},500, function (){
      $(this).css("display", "none")
      $(this).parents("section").find("header > a").animate({opacity:1}, 200)
      div.css("display","inline-block")
      div.animate({opacity:1}, 500)
    });
  });

  $('#email form').bind('copper:invalid', function (){
    $('#email > header > a').click();
    $(this).find('input[itemprop=email]').addClass('invalid');
  });

  user = document.getItems()['users'][((window.location.pathname).replace('/edit', ''))]
  if (!user.email){
    $("#email > header > a").click();
  }
  if (user.stripe_id){
    jQuery.ajax({
      url: '/cards',
      type: 'get',
      success: function (data, textStatus, jqXHR){
        $("#card p.type").text(data.active_card.type)
        $("#card p.number").text(data.active_card.last4)
        $("#card p.expiration").text(data.active_card.exp_month + '/' + data.active_card.exp_year )
      },
      error: function (data, textStatus, jqXHR) {
        console.error("error getting stripe info", data, textStatus, jqXHR);
      }
    });
  }
  else{
    $("#card > header > a").click();
  }
});