<!DOCTYPE html>
<html lang="en_us" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8"/>
    <title>Bookmarklet</title>
  </head>

  <body id="bookmarklet">

    <!-- Packed and placed in bookmarklet with http://dean.edwards.name/packer/,
         URL escaped using TextMate HTML bundle. -->
    <script type="text/javascript">
      var createXMLHttpRequest = function () {
        try {
          return new XMLHttpRequest();
        } catch (e) {
          // do nothing
        }

        try {
          return new ActiveXObject("Msxml2.XMLHTTP");
        } catch (x) {
          // do nothing
        }
        return null;
      };

      var loadScript = function (scriptURL) { 
        var scriptElem = document.createElement('SCRIPT');
        scriptElem.setAttribute('language', 'JavaScript');
        scriptElem.setAttribute('src', scriptURL);
        document.body.appendChild(scriptElem);
      };

      //load the referenced script
      var responseHandler = function (json) {
        var response = eval('(' + json + ')');
        loadScript(response.next_url);
      };

      var patronize = function (w, x) {
        x.open('GET', 'http://0.0.0.0:3000/patronize?patronized=' + encodeURIComponent(w.location));
        x.onreadystatechange = function () {
          if (x.readyState !== 4) {
            return;
          }

          if (x.status === 200) {
            // check the content type of the response should be application/json
            responseHandler(x.responseText);
            //parse response and do what the json says
          }
          else
          {
            //handle non standard http response codes
            // TODO implement handlers for other status codes 404, 500, 503, 302
            alert(x.status);
          }

        };

        x.send();
      };
    </script>

    <ol>
      <li><a href="javascript:var%20createXMLHttpRequest%3Dfunction%28%29%7Btry%7Breturn%20new%20XMLHttpRequest%28%29%7Dcatch%28e%29%7B%7Dtry%7Breturn%20new%20ActiveXObject%28%22Msxml2.XMLHTTP%22%29%7Dcatch%28x%29%7B%7Dreturn%20null%7D%3Bvar%20loadScript%3Dfunction%28a%29%7Bvar%20b%3Ddocument.createElement%28%27SCRIPT%27%29%3Bb.setAttribute%28%27language%27%2C%27JavaScript%27%29%3Bb.setAttribute%28%27src%27%2Ca%29%3Bdocument.body.appendChild%28b%29%7D%3Bvar%20responseHandler%3Dfunction%28a%29%7Bvar%20b%3Deval%28%27%28%27%2Ba%2B%27%29%27%29%3BloadScript%28b.next_url%29%7D%3Bvar%20patronize%3Dfunction%28w%2Cx%29%7Bx.open%28%27GET%27%2C%27http%3A%2F%2F0.0.0.0%3A3000%2Fpatronize%3Fpatronized%3D%27%2BencodeURIComponent%28w.location%29%29%3Bx.onreadystatechange%3Dfunction%28%29%7Bif%28x.readyState%21%3D%3D4%29%7Breturn%7Dif%28x.status%3D%3D%3D200%29%7BresponseHandler%28x.responseText%29%7Delse%7Balert%28x.status%29%7D%7D%3Bx.send%28%29%7D%3Bpatronize%28window%2CcreateXMLHttpRequest%28%29%29%3B">tip this</a></li>
      <li><a href="javascript:patronize(window,createXMLHttpRequest())">Patronize GET with alert callback.</a></li>
    </ol>

    <pre>
      grab the current window's url.
      GET to /patronize URL
    </pre>
  </body>

</html>

