<!DOCTYPE html>
<html lang="en_us" xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8"/>
    <title>Bookmarklet</title>
  </head>

  <body id="bookmarklet">

    <!-- Packed and placed in bookmarklet with http://dean.edwards.name/packer/,
         URL escaped using TextMate HTML bundle. -->
    <script type="text/javascript">
      var createXMLHttpRequest = function () {
        try { return new XMLHttpRequest(); } catch(e) {}
        try { return new ActiveXObject("Msxml2.XMLHTTP"); } catch (e) {}
        return null;
      }

      var loadScript = function (scriptURL) { 
        var scriptElem = document.createElement('SCRIPT');
        scriptElem.setAttribute('language', 'JavaScript');
        scriptElem.setAttribute('src', scriptURL);
        document.body.appendChild(scriptElem);
      }

      //load the referenced script
      var responseHandler = function (json) {
        var response = eval( "(" + json + ")");
        loadScript(response.next_url);
      }

      var patronize = function (w, x) {
        x.open('GET', 'http://0.0.0.0:3000/patronize?patronized=' + encodeURIComponent(w.location));
        x.onreadystatechange = function () {
          if (x.readyState !== 4) {
            return;
          }

          if (x.status === 200){
            // check the content type of the response should be application/json
            responseHandler(x.responseText);
            //parse response and do what the json says
          }
          else{
            //handle non standard http response codes
            // TODO implement handlers for other status codes 404, 500, 503, 302
            alert(x.status);
          }

        }

        x.send();
      };
    </script>

    <ol>
      <li><a href="javascript:var%20patronize%3Dfunction%28w%2Cx%29%7Bx.open%28%27GET%27%2C%27http%3A%2F%2F0.0.0.0%3A3000%2Fpatronize%3Fpatronized%3D%27%2BencodeURIComponent%28w.location%29%29%3Bx.send%28%29%7D%3Bpatronize%28window%2Cnew%20XMLHttpRequest%29%3B">tip this</a></li>
      <li><a href="javascript:patronize(window,createXMLHttpRequest())">Patronize GET with alert callback.</a></li>
    </ol>

    <pre>
      grab the current window's url.
      GET to /patronize URL
    </pre>
  </body>

</html>

